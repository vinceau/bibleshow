<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="static/styles.css">
</head>
<body>
    <div id="controls">
        <input type="text" id="search" />
        <button id="searchButton">Search</button>
        <button id="fullButton">Toggle Fullscreen</button>
        <button id="prevButton" onclick="prev()">Prev</button>
        <button id="nextButton" onclick="next()">Next</button>
    </div>
    <h1 id="header"></h1>
    <div id="content">
        <div id="text_body"></div>
    </div>
    <script src="static/jquery-2.1.3.min.js"></script>
    <script src="static/fullscreen.js"></script>
    <script src="static/scripts.js"></script>
    <script src="static/SplitText.min.js"></script>
    <script src="static/keys.min.js"></script>
    <script src="static/js.cookie.js"></script>
    <script>
//declare globals
var st, max_lines, start, end;

function set_prev(enabled) {
    $('#prevButton').prop('disabled', !enabled);
}

function set_next(enabled) {
    $('#nextButton').prop('disabled', !enabled);
}

function check() {
    set_prev(start > 1);
    set_next(end < st.lines.length);
}

function next() {
    if (end < st.lines.length) {
        hidelines(start, end);
        start += max_lines;
        end += max_lines;
        showlines(start, end);
        check();
    }
}

function prev() {
    if (start > 1) {
        hidelines(start, end);
        start -= max_lines;
        end -= max_lines;
        showlines(start, end);
        check();
    }
}

function reset(hard=false) {
    if (hard) {
        console.log('hard reset');
        //create a new SplitText object with current text
        st = new SplitText("#text_body", {
            type: "lines",
            linesClass: "line++",
        });
    } else {
        console.log('soft reset');
        //resplit the current text without creating new SplitText object
        st.split();
    }
    start = 1;
    end = st.lines.length;
    for (var i = 1; i <= end; i++) {
        var el = $('.line' + i);
        if (el.fits()) {
            continue;
        }
        //i is the first element that's hidden completely
        //so subtract one to specify the last shown line
        end = i - 1;
        break;
    }
    hidelines(end + 1, st.lines.length);
    max_lines = end;
    check();
}

function load_passage(passage) {
    var bible_url = 'https://api.biblia.com/v1/bible/content/LEB.json?key=fd37d8f28e95d3be8cb4fbc37e15e18e&style=simpleParagraphs&passage=';
    $.getJSON(bible_url + passage, function(data) {
        console.log("Successfully data recived");
        $('#header').html(passage);
        $('#search').val(passage);
        $('#text_body').html(data.text);
        reset(true);
        Cookies.set('passage', passage);
    }).fail(function() {
        $('#header').html('Error');
        $('#text_body').html('Couldn\'t find passage: ' + passage);
    });
}

window.Bindings = Keys.Bindings;
window.Combo    = Keys.Combo;
window.Key      = Keys.Key;

// Initialize application-wide bindings manager
window.bindings = new Bindings();

bindings.load({
    nextPage: {
        bind: [
            new Combo(Key.Spacebar),
            new Combo(Key.Right),
            new Combo(Key.Down)
            ],
        handler: next
    },
    prevPage: {
        bind: [
            new Combo(Key.Backspace),
            new Combo(Key.Left),
            new Combo(Key.Up)
            ],
        handler: prev
    }
});

$(window).on('resize', debounce(function() {
    reset();
}, 200));

$('#searchButton').click(function() {
    load_passage($('#search').val());
});

$('#fullButton').click(function() {
    if (currentlyFullscreen()) {
        exitFullscreen();
    } else {
        launchIntoFullscreen(document.body);
    }
    reset();
});

var passage = Cookies.get('passage');
if (passage) {
    load_passage(passage);
} else {
    load_passage('Genesis 1');
}
    </script>
</body>
</html>

